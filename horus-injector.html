<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <title>Horus Injector</title>
        <script type='text/javascript' src='js/jquery-3.2.1.min.js'></script>
        <script type='text/javascript' src='js/popper.min.js'></script>
        <script type='text/javascript' src='FileSaver.js'></script>
        <script type='text/javascript' src='Blob.js'></script>
        <script type='text/javascript' src='js/bootstrap.bundle.js'></script>
        <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
        <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.css" />
        <script type='text/javascript'>
        var horusTemplates = {};
        jQuery(document).ready(function(){
          $.get('getHorusDestinations.php',null,getTemplates,'json');     
          $("#select").change(selectTemplate);
          $("#go").click(getOutput);
          $("#save").click(save);
          $("#restore").click(retrieve);
          $("#fileselect").change(getFileName);
        });

        function getTemplates(res){
            horusTemplates = res;
            var option = '<option value="-1">Select</option>';
            $.each(res,function(i,d){
                //option += '<option>'+d.name+'<\/option>';
                option += '<option value="' + i + '">'+i+'<\/option>';
            });
            $("#select").html(option);

        };

        function selectTemplate(){
            var opt = $("#select option:selected").text();
            for (var i = 0; i<Object.keys(horusTemplates).length; i++){
                if (Object.keys(horusTemplates)[i]===opt){
                    var table = '<table><tr><th>Variable</th><th>Value</th></tr>';
                    var indx = Object.keys(horusTemplates)[i];
                    for (var j=0;j<horusTemplates[indx].length; j++){
                        var indxj = horusTemplates[indx][j];
                        table += '<tr><td>'+indxj+'</td><td id="'+indxj+'"><input id="val_'+indxj+'"></input></td></tr>';
                    }
                    $("#tab").html(table);
                }
            }
        }

         function getOutput(){
            var output = {attr: {}};
            output.template = $("#select option:selected").text();
            output.repeat = $("#number").val();
            $("#tab tr td input").each(function(){
                 output.attr[$(this).attr("id").substring(4)] = $(this).val();
            });
            $.ajaxSetup({
                contentType: "application/json; charset=utf-8",
                headers: {'x_destination_url': $("#destination").val()}
            });
            $.post($("#proxy").val(),JSON.stringify(output),function(res){alert(JSON.stringify(res))},"json");
         };

         function save(){
             //$("#fileselect").trigger("click");
             //alert($("#fileselect").attr("value"));
             var output = {attr: {}};
             output.template = $("#select option:selected").text();
             output.repeat = $("#number").val();
             $("#tab tr td input").each(function(){
                  output.attr[$(this).attr("id").substring(4)] = $(this).val();
             });
             output.proxy = $("#proxy").val();
             output.destination = $("#destination").val();
             saveAs(new Blob([(JSON.stringify(output))]),$("#saveas").val());

         };

         function retrieve(){
             $("#fileselect").trigger("click");
         }

        function getFileName(){
            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    $("#saveas").val($("#fileselect").get(0).files[0].name);
                    var res = JSON.parse(e.target.result);
                    $("#select").val(res.template);
                    selectTemplate();
                    $("#proxy").val(res.proxy);
                    $("#destination").val(res.destination);
                    $("#number").val(res.repeat);
                    $.each(res.attr,function(index,item){
                        $("#val_"+index).val(item);
                    });
            };})($("#fileselect").get(0).files[0]);
            reader.readAsText($("#fileselect").get(0).files[0]);
                

        }; 
        </script>
    </head>
    <body>
        <div class="container">
        <!--form-->
            <div class="form-group row">
                <div class="input-group"><div class="input-group-prepend"><button class="btn" id="save">Save</button></div><input type="text" id="saveas" value="horus_injector_export.json"/>
                <div class="input-group-append"><button class="btn" id="restore">Retrieve</button></div></div>
                <input type="file" style="display: none" id="fileselect"/>
            </div>

            <div class="form-group row">
                <!--div class="input-group"-->
                    <label for="select" class="col-sm-2 col-form-label">Template:</label>
                    <div class="col-sm-10"><select class="form-control" id="select"></select></div>
                <!--/div-->
            </div>
            <div class="form-group row">
                <div class="col-sm-12">
                    <table id="tab"></table>
                </div>
            </div>
            <div class="form-group row">
                <!--div class="input-group"-->
                    <label for="proxy" class="col-sm-2 col-form-label">Transformation Url:</label>
		    <div class="col-sm-10"><textarea class="form-control" id="proxy"></textarea></div>
                <!--/div-->
            </div>
            <div class="form-group row">
                <!--div class="input-group"-->
                    <label for="destination" class="col-sm-2 col-form-label">Endpoint Url:</label>
                    <div class="col-sm-10"><textarea class="form-control" id="destination"></textarea></div>
                <!--/div-->
            </div>
            <div class="form-group row">
                <!--div class="input-group"-->
                    <label for="number" class="col-sm-2 col-form-label">Number of messages:</label>
                    <div class="col-sm-10"><input class="form-control" id="number" value="1"/></div>
                <!--/div-->
            </div>
            <div class="form-group row">
                <div class=""><button class="btn" id="go">Send</button></div>
            </div>
        <!--/form-->
        </div>
    </body>
</html>


